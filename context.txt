================================================================================
BALL KNOWLEDGE — CONTEXT FILE
================================================================================
Last Updated: 2026-02-20

================================================================================
PENDING / MONITOR
================================================================================

[ ] NFL 2025 CAREER STATS — NOT YET AVAILABLE
    nfl_data_py import_seasonal_data([2025]) returns HTTP 404 — the post-season
    parquet files have not been published yet (as of 2026-02-19, Seattle just won
    the Super Bowl). Check periodically:
      cd scripts && python -c "import nfl_data_py as nfl; print(nfl.import_seasonal_data([2025]))"
    When it works (no 404), run:
      python generate_nfl_careers.py   (or update_nba_careers.py equivalent for NFL)
      cp data/nfl_careers.json ../public/data/nfl_careers.json
    NFL rosters for 2025 ARE already generated (nfl_data_py handles rosters
    separately from season stats). Only career stats are missing.
Sports: NBA + NFL
Deployment: Vercel only (frontend + all static data). Render fully decommissioned.

================================================================================
WHAT THIS APP IS
================================================================================
Multiplayer + solo sports roster trivia game. Players guess who was on a team's
roster in a given season within a time limit. Supports NBA and NFL. Multiple
game modes: Roster Royale, Division Mode, Career Mode, Name Scramble, Roll Call.

Tech Stack:
- Frontend:  React 19 + TypeScript + Vite 7
- Styling:   Tailwind CSS 4 + Framer Motion + custom retro theme (index.css)
- State:     Zustand (with persistence middleware)
- Search:    Fuse.js fuzzy matching + react-window virtualized lists
- Realtime:  Supabase (multiplayer lobbies, leaderboard)
- Data:      Static JSON files on Vercel CDN (roster/career data)
- Backend:   None. Everything is static JSON on Vercel CDN.

================================================================================
ARCHITECTURE — DATA FLOW (CRITICAL TO UNDERSTAND)
================================================================================

ROSTER MODE (NBA + NFL) — FULLY STATIC, NO BACKEND NEEDED
----------------------------------------------------------
All roster data is pre-generated and served as static JSON files from Vercel.
No api_server.py or nfl_api_server.py needed for roster/division/roll call modes.

Host can assign adaptive score multipliers (1×, 1.5×, 2×, 3×, 4×) per player
in the lobby waiting room. Multiplier affects:
  - Effective score in LiveScoreboard during gameplay (solo: score × multiplier)
  - Team combined score (weighted sum: Σ member.score × member.score_multiplier)
  - Results display in MultiplayerResultsPage (badge + breakdown line)
Multiplier state stored as score_multiplier column in lobby_players table.
setPlayerScoreMultiplier() in lobby.ts updates it; cycles via button in LobbyWaitingPage.

Game start flow:
1. User picks team + season (or random)
2. Frontend fetches ONE static JSON file from Vercel CDN:
   NBA:  /data/rosters/{HIST_ABBR}_{SEASON}.json   e.g. NJN_2004-05.json
   NFL:  /data/nfl/rosters/{TEAM}_{YEAR}.json       e.g. KC_2023.json
3. Frontend fetches ONE autocomplete file:
   NBA:  /data/players/{SEASON}.json
   NFL:  /data/nfl/players/{YEAR}.json
4. Game starts instantly — no API calls, no cold starts, no race conditions

Career mode flow:
1. careerData.ts fetches /data/nba_careers.json or /data/nfl_careers.json once
2. Caches in memory for the session
3. Random player selection + stat lookup happen entirely client-side

NAME SCRAMBLE MODE — FULLY STATIC
-----------------------------------
Uses the same career JSON pools (nba_careers.json / nfl_careers.json).
getRandomNBAScramblePlayer() / getRandomNFLScramblePlayer() in careerData.ts
pick a random player from the career pool (no stat display needed).
scrambleName() in scramble.ts shuffles each word independently (Fisher-Yates),
preserving words ≤2 chars and guaranteeing the result differs from the original.

Solo flow (SoloScramblePage):
  Player sees scrambled name → types guesses (fuzzy match via areSimilarNames)
  → reveals answer on correct/give-up → Next Player continues the streak.

Multiplayer flow (MultiplayerNameScramblePage):
  Host picks sport + win_target at lobby creation. Host starts each round by
  calling startCareerRound() with a new ScrambleState (playerName, scrambledName,
  round, win_target, career_to) stored in lobby.career_state.
  - All players see the scrambled name and type guesses simultaneously.
  - First correct answer triggers a 30-second pressure timer for remaining players.
  - When all players submit (correct or give-up), host awards positional points:
    1st=5, 2nd=3, 3rd=2, 4th=1 via addCareerPoints() → stored in player.wins.
  - Between rounds: interstitial shows scramble/answer reveal, per-round pts,
    and race-to-target progress bars.
  - Host clicks "Next Round" to load a fresh scrambled player.
  - First player to reach win_target total pts triggers lobby status='finished'
    → navigate to MultiplayerNameScrambleResultsPage with full roundHistory.

NBA abbreviation translation (src/utils/teamHistory.ts → getApiAbbreviation()):
  BKN pre-2012  → NJN    OKC pre-2008  → SEA
  NOP pre-2013  → NOH    MEM pre-2001  → VAN
  (All other teams: abbreviation unchanged)

NFL uses CURRENT abbreviations always (LAR for all Rams years, LV for all
Raiders years, LAC for all Chargers years). Alias normalisation is done
at script generation time, not at runtime.

CAREER MODE — FULLY STATIC
---------------------------
Career mode uses careerData.ts which fetches static JSON from Vercel CDN:
  NBA:  /data/nba_careers.json   (736 players, season-by-season stats)
  NFL:  /data/nfl_careers.json   (584 players, QB/RB/WR/TE only)
Random selection and filtering happen client-side. No backend needed.
Render is fully decommissioned — api_server.py and nfl_api_server.py are archived.

MULTIPLAYER — SUPABASE REALTIME
---------------------------------
Lobby creation, player sync, roll call sessions all use Supabase Realtime.
No custom backend needed. Works independently of Render.

================================================================================
STATIC DATA FILES (public/data/)
================================================================================

public/data/
  rosters/
    {HIST_ABBR}_{SEASON}.json     NBA roster per team per season (2000-2025)
    e.g. LAL_2023-24.json, NJN_2004-05.json, SEA_2006-07.json
    ~775 files total (30 teams × 26 seasons), ~5-8 KB each
  players/
    {SEASON}.json                 All NBA players that season (autocomplete)
    e.g. 2023-24.json
    26 files, ~15 KB each
  nba_careers.json                736 NBA players, full season-by-season stats (1.1 MB)
  nfl_careers.json                584 NFL players, QB/RB/WR/TE only (596 KB)
  nfl/
    rosters/
      {TEAM}_{YEAR}.json          NFL roster per team per season (2000-2025)
      e.g. KC_2023.json, LAR_2015.json
      ~754 files total (32 teams × 26 seasons), ~15-20 KB each
    players/
      {YEAR}.json                 All NFL players that season (autocomplete)
      26 files, ~50 KB each

Roster file format (NBA):
  { "team": "NJN", "season": "2004-05", "players": [
    { "id": 123, "name": "Jason Kidd", "position": "G",
      "number": "5", "ppg": 15.4, "isLowScorer": false }, ... ] }

Roster file format (NFL):
  { "team": "KC", "season": 2023, "players": [
    { "id": "00-0033873", "name": "Patrick Mahomes", "position": "QB",
      "number": "15", "unit": "Offense" }, ... ] }

Player file format (both sports): [{ "id": ..., "name": "..." }, ...]

scripts/data/ (NOT served publicly — used by Render for career mode):
  nba_careers.json   1.1 MB, 736 players, full season-by-season stats
  nfl_careers.json   596 KB, 584 players (QB/RB/WR/TE only)

scripts/.cache/        NBA roster generation cache (team_season.json, 24hr expiry)
scripts/.nfl_cache/    NFL roster generation cache (nfl_team_year.json, 1wk expiry)

================================================================================
SOURCE FILE MAP
================================================================================

PAGES (src/pages/)
  HomePage.tsx              Landing page: mode select, team/year picker, start game
  GamePage.tsx              Active game: input, timer, score, player cards
  ResultsPage.tsx           End screen: roster reveal, score, leaderboard submit
  CareerGamePage.tsx        Career mode game (NBA)
  CareerResultsPage.tsx     Career mode results
  MultiplayerCareerPage.tsx Multiplayer career mode game
  MultiplayerCareerResultsPage.tsx
  SoloScramblePage.tsx      Solo Name Scramble: unscramble one player at a time,
                            streak tracking, NBA/NFL toggle
  MultiplayerNameScramblePage.tsx
                            Multiplayer Name Scramble: positional race scoring,
                            pressure timer, between-round interstitial
  MultiplayerNameScrambleResultsPage.tsx
                            Final results + round-by-round history for scramble
  LobbyCreatePage.tsx       Create multiplayer lobby
  LobbyJoinPage.tsx         Join multiplayer lobby
  LobbyWaitingPage.tsx      Waiting room pre-game; host sets score multipliers
                            (1×→1.5×→2×→3×→4×→1× cycle) per player
  MultiplayerResultsPage.tsx
  RollCallCreatePage.tsx    Roll Call mode setup
  RollCallSessionPage.tsx   Roll Call active session
  RollCallResultsPage.tsx

SERVICES (src/services/)
  roster.ts         PRIMARY DATA LAYER for roster mode. Fetches static JSON
                    files. Functions:
                      fetchTeamRoster(abbr, season)        NBA static → legacy fallback
                      fetchStaticSeasonPlayers(season)     NBA autocomplete
                      fetchStaticNFLRoster(abbr, year)     NFL static
                      fetchStaticNFLSeasonPlayers(year)    NFL autocomplete
                      fetchDivisionRosters(sport, abbrs, season)  4-team merge
  careerData.ts     Static career data loader. Fetches nba_careers.json /
                    nfl_careers.json from Vercel CDN once per session.
                    Random selection + filtering are client-side.
  careerPrefetch.ts Background prefetch for career mode (keeps 2 players cached)
  api.ts            *** ARCHIVED — NOT IMPORTED ANYWHERE ***
                    Was the NBA Render backend client. Superseded by static files.
  nfl-api.ts        *** ARCHIVED — NOT IMPORTED ANYWHERE ***
                    Was the NFL Render backend client. Superseded by static files.
  lobby.ts          Supabase lobby operations. setPlayerScoreMultiplier() updates
                    score_multiplier for a player; startCareerRound() writes
                    career_state for scramble/career rounds.
  leaderboard.ts    Supabase leaderboard operations
  rollCall.ts       Roll Call mode Supabase operations

STORES (src/stores/)
  gameStore.ts      Active game state (team, season, players, guesses, score)
  settingsStore.ts  Persisted settings (timer duration, sport, hide results)
  lobbyStore.ts     Multiplayer lobby state
  careerStore.ts    Career mode game state
  rollCallStore.ts  Roll Call session state

UTILS (src/utils/)
  teamHistory.ts    getApiAbbreviation(abbr, year, sport) — NBA historical
                    abbreviation translation. CRITICAL for static file lookups.
  teamUtils.ts      Team helper functions. combinedScore now uses
                    Σ(member.score × member.score_multiplier) for weighted teams.
  teamAbbr.ts       Abbreviation utilities
  fuzzyDedup.ts     Fuzzy deduplication for player name matching
  scramble.ts       scrambleName(name) — Fisher-Yates word-by-word shuffle.
                    Words ≤2 chars unchanged. Guarantees result ≠ original.

DATA (src/data/)
  teams.ts          All 30 NBA teams (id, abbreviation, name, colors)
  nfl-teams.ts      All 32 NFL teams (id, abbreviation, name, colors, division)
  rosters.ts        LEGACY — handful of hardcoded team-seasons. Only used as
                    last-resort fallback if static JSON file not found.

COMPONENTS (src/components/)
  home/
    TeamSelector.tsx      Team picker dropdown
    YearSelector.tsx      Season/year picker
    RouletteOverlay.tsx   Dealing animation before game starts
    SettingsModal.tsx     Timer + settings UI
    ServerWarmup.tsx      OLD warmup splash — now disabled (showWarmup=false)
  game/
    PlayerInput.tsx       Autocomplete input with fuzzy search
    Timer.tsx             Countdown timer
    ScoreDisplay.tsx      Score + progress
    TeamDisplay.tsx       Team name + season header
    GuessedPlayersList.tsx  Correct/incorrect player cards
  multiplayer/
    LiveScoreboard.tsx    Real-time multiplayer scores
  leaderboard/
    Leaderboard.tsx, LeaderboardTable.tsx

HOOKS (src/hooks/)
  useLobbySubscription.ts    Supabase realtime lobby updates
  useRollCallSubscription.ts Supabase realtime roll call updates

================================================================================
SCRIPTS (scripts/)
================================================================================

DATA GENERATION (run once, output goes to public/data/):
  generate_nba_rosters.py   Generates NBA static roster + player JSON files
                            Uses: .cache/ first (fast), NBA API for misses
                            Output: public/data/rosters/ + public/data/players/
                            Run: python generate_nba_rosters.py
                            Resume-safe: skips existing files by default
                            Options: --start-year --end-year --teams --force

  generate_nfl_rosters.py   Generates NFL static roster + player JSON files
                            Uses: .nfl_cache/ first, then nfl_data_py (local, fast)
                            Output: public/data/nfl/rosters/ + public/data/nfl/players/
                            Run: python generate_nfl_rosters.py
                            Resume-safe: skips existing files by default

  generate_nba_careers.py   Generates nba_careers.json for career mode
                            Output: scripts/data/nba_careers.json (1.1 MB, 736 players)
                            Slow (~30-40 min), resumable with --resume

  generate_nfl_careers.py   Generates nfl_careers.json for career mode
                            Output: scripts/data/nfl_careers.json (596 KB, 584 players)
                            Uses nfl_data_py (fast, local)

  update_nba_careers.py     Incremental NBA career stats updater. Appends new
                            seasons to existing players in nba_careers.json.
                            1 API call per season + 2 per new player only.
                            Run: python update_nba_careers.py --years 2025 2026

  extract_rosters.py        *** ARCHIVED *** Old monolithic extraction to src/data/.
                            Superseded by generate_nba_rosters.py. Safe to delete.

  quick_extract.py          *** ARCHIVED *** Test script for extract_rosters.py.
                            Safe to delete.

BACKEND SERVERS (*** ARCHIVED — RENDER FULLY DECOMMISSIONED ***):
  api_server.py             *** ARCHIVED *** Was NBA FastAPI server on Render.
                            Career mode now uses static nba_careers.json.
                            Roster endpoints were already bypassed by static files.

  nfl_api_server.py         *** ARCHIVED *** Was NFL FastAPI server on Render.
                            Career mode now uses static nfl_careers.json.
                            Roster endpoints were already bypassed by static files.

================================================================================
ENVIRONMENT VARIABLES
================================================================================

VITE_SUPABASE_URL      Supabase project URL
VITE_SUPABASE_ANON_KEY Supabase anon key

VITE_API_URL           *** UNUSED *** Was NBA Render backend URL. Safe to delete
                       from Vercel env vars.
VITE_NFL_API_URL       *** UNUSED *** Was NFL Render backend URL. Safe to delete
                       from Vercel env vars.

================================================================================
COMMANDS
================================================================================

# Dev — no Python servers needed, everything is static
npm run dev           # localhost:5173

# Generate static roster files (one-time setup or to add new seasons)
cd scripts
python generate_nba_rosters.py          # ~30-40 min first run
python generate_nfl_rosters.py          # ~2-5 min (nfl_data_py is local)

# Monitor generation progress
tail -f /tmp/nba_roster_gen.log
tail -f /tmp/nfl_roster_gen.log

# Regenerate career pools (full rebuild — slow)
python generate_nba_careers.py          # ~30-40 min
python generate_nfl_careers.py          # fast (nfl_data_py local)

# Incremental NBA career update (append new seasons to existing players)
python update_nba_careers.py --years 2025 2026   # 2-5 min

# After generating careers, copy to public/data/ for Vercel:
cp data/nba_careers.json ../public/data/nba_careers.json
cp data/nfl_careers.json ../public/data/nfl_careers.json

================================================================================
KEY DECISIONS & GOTCHAS
================================================================================

1. NBA HISTORICAL ABBREVIATIONS
   Static files use historical abbrs (NJN not BKN for pre-2012).
   getApiAbbreviation() in teamHistory.ts handles translation at fetch time.
   If adding a new relocated team, update BOTH teamHistory.ts AND
   HISTORICAL_ABBR dict in generate_nba_rosters.py.

2. NFL ABBREVIATIONS
   Always use current abbreviations in filenames (LAR, LV, LAC for all years).
   Alias mapping (STL→LAR etc.) is done in generate_nfl_rosters.py at write time.
   Frontend uses current abbr directly — no translation layer needed.

3. SERVER WARMUP SCREEN
   ServerWarmup.tsx still exists but is DISABLED (showWarmup=false in HomePage).
   Both sports use static files so no warmup delay. Component kept for reference.

4. CAREER MODE IS NOW FULLY STATIC
   nba_careers.json + nfl_careers.json live in public/data/ and are fetched
   client-side by careerData.ts. No Render cold start. First load downloads
   the JSON once per session (~1-2s); subsequent lookups are instant.

5. DIVISION MODE
   fetchDivisionRosters() in roster.ts fetches 4 teams in parallel.
   Uses static JSON files (fetchSingleTeamRoster → fetchStaticNFLRoster / fetchTeamRoster).
   Was previously slow due to sequential API calls; now instant from CDN.

6. AUTOCOMPLETE
   NBA: fetchStaticSeasonPlayers(season) → /data/players/{season}.json
   NFL: fetchStaticNFLSeasonPlayers(year) → /data/nfl/players/{year}.json
   These contain ALL players league-wide that season (not just the team roster)
   so autocomplete doesn't give away answers.

7. PPG / isLowScorer
   NBA roster files include ppg and isLowScorer (true if ppg < 10) for players
   fetched from .cache/ (which has real PPG). Players fetched via API fallback
   have ppg=0.0 and isLowScorer=false (acceptable — only affects display hints).

8. PLAYER ID TYPES
   NBA player IDs are integers. NFL player IDs are strings ("00-0033873").
   Keep this in mind when comparing or storing IDs.

9. react-window: use v1.8.x (NOT v2.x — breaking API changes in v2)

10. SUPABASE IS OPTIONAL
    App fully works without Supabase (leaderboard shows "not configured").
    Required only for multiplayer and leaderboard features.

================================================================================
RETRO THEME CSS CLASSES (src/index.css)
================================================================================

Typography:   .retro-title (Bebas Neue)   .sports-font (Oswald)
Panels:       .scoreboard-panel   .vintage-card   .player-card (.guessed)
Buttons:      .retro-btn   .retro-btn-gold   .retro-btn-blue
Inputs:       .retro-input   .retro-select
Progress:     .retro-progress   .retro-progress-fill
Utilities:    .team-badge   .pulse-glow   .scoreboard-number

CSS Variables:
  --nba-orange: #f15a29    --nba-gold: #fdb927
  --nba-red: #c8102e       --nba-blue: #17408b
  --vintage-cream: #f5f5dc --led-active: #ff6b35

================================================================================
