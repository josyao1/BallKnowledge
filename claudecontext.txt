================================================================================
BALL KNOWLEDGE — CLAUDE CONTEXT FILE
================================================================================
Last Updated: 2026-02-19
Sports: NBA + NFL
Deployment: Vercel (frontend + static data), Render (career mode only)

================================================================================
WHAT THIS APP IS
================================================================================
Multiplayer + solo sports roster trivia game. Players guess who was on a team's
roster in a given season within a time limit. Supports NBA and NFL. Multiple
game modes: Roster Guessing, Division Mode, Career Mode, Roll Call.

Tech Stack:
- Frontend:  React 19 + TypeScript + Vite 7
- Styling:   Tailwind CSS 4 + Framer Motion + custom retro theme (index.css)
- State:     Zustand (with persistence middleware)
- Search:    Fuse.js fuzzy matching + react-window virtualized lists
- Realtime:  Supabase (multiplayer lobbies, leaderboard)
- Data:      Static JSON files on Vercel CDN (roster/career data)
- Backend:   FastAPI on Render — ONLY for career mode (see below)

================================================================================
ARCHITECTURE — DATA FLOW (CRITICAL TO UNDERSTAND)
================================================================================

ROSTER MODE (NBA + NFL) — FULLY STATIC, NO BACKEND NEEDED
----------------------------------------------------------
All roster data is pre-generated and served as static JSON files from Vercel.
No api_server.py or nfl_api_server.py needed for roster/division/roll call modes.

Game start flow:
1. User picks team + season (or random)
2. Frontend fetches ONE static JSON file from Vercel CDN:
   NBA:  /data/rosters/{HIST_ABBR}_{SEASON}.json   e.g. NJN_2004-05.json
   NFL:  /data/nfl/rosters/{TEAM}_{YEAR}.json       e.g. KC_2023.json
3. Frontend fetches ONE autocomplete file:
   NBA:  /data/players/{SEASON}.json
   NFL:  /data/nfl/players/{YEAR}.json
4. Game starts instantly — no API calls, no cold starts, no race conditions

NBA abbreviation translation (src/utils/teamHistory.ts → getApiAbbreviation()):
  BKN pre-2012  → NJN    OKC pre-2008  → SEA
  NOP pre-2013  → NOH    MEM pre-2001  → VAN
  (All other teams: abbreviation unchanged)

NFL uses CURRENT abbreviations always (LAR for all Rams years, LV for all
Raiders years, LAC for all Chargers years). Alias normalisation is done
at script generation time, not at runtime.

CAREER MODE — STILL USES RENDER BACKEND
----------------------------------------
Career mode hits api_server.py (NBA) and nfl_api_server.py (NFL) on Render.
These servers load pre-built JSON files into memory at startup and serve:
  GET /career/random?career_from=X&career_to=Y  → random player from pool
  GET /career/{player_id}                        → full career stats

NOTE: Career mode could also be moved to static (same pattern — just load
nba_careers.json / nfl_careers.json in the browser and pick randomly
client-side). This would kill Render entirely. Not done yet.

MULTIPLAYER — SUPABASE REALTIME
---------------------------------
Lobby creation, player sync, roll call sessions all use Supabase Realtime.
No custom backend needed. Works independently of Render.

================================================================================
STATIC DATA FILES (public/data/)
================================================================================

public/data/
  rosters/
    {HIST_ABBR}_{SEASON}.json     NBA roster per team per season (2000-2024)
    e.g. LAL_2023-24.json, NJN_2004-05.json, SEA_2006-07.json
    ~750 files total (30 teams × 25 seasons), ~5-8 KB each
  players/
    {SEASON}.json                 All NBA players that season (autocomplete)
    e.g. 2023-24.json
    25 files, ~15 KB each
  nfl/
    rosters/
      {TEAM}_{YEAR}.json          NFL roster per team per season (2000-2024)
      e.g. KC_2023.json, LAR_2015.json
      ~800 files total (32 teams × 25 seasons), ~15-20 KB each
    players/
      {YEAR}.json                 All NFL players that season (autocomplete)
      25 files, ~50 KB each

Roster file format (NBA):
  { "team": "NJN", "season": "2004-05", "players": [
    { "id": 123, "name": "Jason Kidd", "position": "G",
      "number": "5", "ppg": 15.4, "isLowScorer": false }, ... ] }

Roster file format (NFL):
  { "team": "KC", "season": 2023, "players": [
    { "id": "00-0033873", "name": "Patrick Mahomes", "position": "QB",
      "number": "15", "unit": "Offense" }, ... ] }

Player file format (both sports): [{ "id": ..., "name": "..." }, ...]

scripts/data/ (NOT served publicly — used by Render for career mode):
  nba_careers.json   1.1 MB, 736 players, full season-by-season stats
  nfl_careers.json   596 KB, 584 players (QB/RB/WR/TE only)

scripts/.cache/        NBA api_server file cache (team_season.json, 24hr expiry)
scripts/.nfl_cache/    NFL api_server file cache (nfl_team_year.json, 1wk expiry)

================================================================================
SOURCE FILE MAP
================================================================================

PAGES (src/pages/)
  HomePage.tsx              Landing page: mode select, team/year picker, start game
  GamePage.tsx              Active game: input, timer, score, player cards
  ResultsPage.tsx           End screen: roster reveal, score, leaderboard submit
  CareerGamePage.tsx        Career mode game (NBA)
  CareerResultsPage.tsx     Career mode results
  MultiplayerCareerPage.tsx Multiplayer career mode game
  MultiplayerCareerResultsPage.tsx
  LobbyCreatePage.tsx       Create multiplayer lobby
  LobbyJoinPage.tsx         Join multiplayer lobby
  LobbyWaitingPage.tsx      Waiting room pre-game
  MultiplayerResultsPage.tsx
  RollCallCreatePage.tsx    Roll Call mode setup
  RollCallSessionPage.tsx   Roll Call active session
  RollCallResultsPage.tsx

SERVICES (src/services/)
  roster.ts         PRIMARY DATA LAYER for roster mode. Fetches static JSON
                    files. Functions:
                      fetchTeamRoster(abbr, season)        NBA static → legacy fallback
                      fetchStaticSeasonPlayers(season)     NBA autocomplete
                      fetchStaticNFLRoster(abbr, year)     NFL static
                      fetchStaticNFLSeasonPlayers(year)    NFL autocomplete
                      fetchDivisionRosters(sport, abbrs, season)  4-team merge
  api.ts            NBA backend client (Render). Now only used for CAREER MODE:
                      fetchRandomCareerPlayer(filters)
                      fetchCareerStats(playerId)
                    Legacy roster functions still exist but are NOT called for
                    roster mode anymore (static files used instead).
  nfl-api.ts        NFL backend client (Render). Now only used for CAREER MODE:
                      fetchNFLRandomCareerPlayer(position, filters)
                      fetchNFLCareerStats(playerId)
                    NFL roster functions are fallback only (static preferred).
  careerPrefetch.ts Background prefetch for career mode (keeps 2 players cached)
  lobby.ts          Supabase lobby operations
  leaderboard.ts    Supabase leaderboard operations
  rollCall.ts       Roll Call mode Supabase operations

STORES (src/stores/)
  gameStore.ts      Active game state (team, season, players, guesses, score)
  settingsStore.ts  Persisted settings (timer duration, sport, hide results)
  lobbyStore.ts     Multiplayer lobby state
  careerStore.ts    Career mode game state
  rollCallStore.ts  Roll Call session state

UTILS (src/utils/)
  teamHistory.ts    getApiAbbreviation(abbr, year, sport) — NBA historical
                    abbreviation translation. CRITICAL for static file lookups.
  teamUtils.ts      Team helper functions
  teamAbbr.ts       Abbreviation utilities
  fuzzyDedup.ts     Fuzzy deduplication for player name matching

DATA (src/data/)
  teams.ts          All 30 NBA teams (id, abbreviation, name, colors)
  nfl-teams.ts      All 32 NFL teams (id, abbreviation, name, colors, division)
  rosters.ts        LEGACY — handful of hardcoded team-seasons. Only used as
                    last-resort fallback if static JSON file not found.

COMPONENTS (src/components/)
  home/
    TeamSelector.tsx      Team picker dropdown
    YearSelector.tsx      Season/year picker
    RouletteOverlay.tsx   Dealing animation before game starts
    SettingsModal.tsx     Timer + settings UI
    ServerWarmup.tsx      OLD warmup splash — now disabled (showWarmup=false)
  game/
    PlayerInput.tsx       Autocomplete input with fuzzy search
    Timer.tsx             Countdown timer
    ScoreDisplay.tsx      Score + progress
    TeamDisplay.tsx       Team name + season header
    GuessedPlayersList.tsx  Correct/incorrect player cards
  multiplayer/
    LiveScoreboard.tsx    Real-time multiplayer scores
  leaderboard/
    Leaderboard.tsx, LeaderboardTable.tsx

HOOKS (src/hooks/)
  useLobbySubscription.ts    Supabase realtime lobby updates
  useRollCallSubscription.ts Supabase realtime roll call updates

================================================================================
SCRIPTS (scripts/)
================================================================================

DATA GENERATION (run once, output goes to public/data/):
  generate_nba_rosters.py   Generates NBA static roster + player JSON files
                            Uses: .cache/ first (fast), NBA API for misses
                            Output: public/data/rosters/ + public/data/players/
                            Run: python generate_nba_rosters.py
                            Resume-safe: skips existing files by default
                            Options: --start-year --end-year --teams --force

  generate_nfl_rosters.py   Generates NFL static roster + player JSON files
                            Uses: .nfl_cache/ first, then nfl_data_py (local, fast)
                            Output: public/data/nfl/rosters/ + public/data/nfl/players/
                            Run: python generate_nfl_rosters.py
                            Resume-safe: skips existing files by default

  generate_nba_careers.py   Generates nba_careers.json for career mode
                            Output: scripts/data/nba_careers.json (1.1 MB, 736 players)
                            Slow (~30-40 min), resumable with --resume

  generate_nfl_careers.py   Generates nfl_careers.json for career mode
                            Output: scripts/data/nfl_careers.json (596 KB, 584 players)
                            Uses nfl_data_py (fast, local)

  extract_rosters.py        OLD extraction script — outputs monolithic rosters.json
                            to src/data/. Superseded by generate_nba_rosters.py.

BACKEND SERVERS (only needed for career mode):
  api_server.py             FastAPI, port 8000. Serves:
                              GET /career/random   random NBA career player
                              GET /career/{id}     NBA career stats
                            Also has legacy roster endpoints (now bypassed by
                            static files). Loads nba_careers.json at startup.

  nfl_api_server.py         FastAPI, port 8001. Serves:
                              GET /nfl/career/random   random NFL career player
                              GET /nfl/career/{id}     NFL career stats
                            Also has legacy NFL roster endpoints. Loads
                            nfl_careers.json at startup.

================================================================================
ENVIRONMENT VARIABLES
================================================================================

VITE_API_URL          NBA backend URL (default: http://localhost:8000)
                      Production: Render URL. Only needed for career mode.
VITE_NFL_API_URL      NFL backend URL (default: http://localhost:8001)
                      Production: Render URL. Only needed for career mode.
VITE_SUPABASE_URL     Supabase project URL
VITE_SUPABASE_ANON_KEY Supabase anon key

================================================================================
COMMANDS
================================================================================

# Dev (no Python servers needed for roster mode)
npm run dev           # localhost:5173

# If you need career mode locally:
cd scripts
uvicorn api_server:app --port 8000      # NBA career
uvicorn nfl_api_server:app --port 8001  # NFL career

# Generate static roster files (one-time setup)
cd scripts
python generate_nba_rosters.py          # ~30-40 min first run
python generate_nfl_rosters.py          # ~2-5 min (nfl_data_py is local)

# Monitor generation progress
tail -f /tmp/nba_roster_gen.log
tail -f /tmp/nfl_roster_gen.log

# Regenerate career pools
python generate_nba_careers.py          # ~30-40 min
python generate_nfl_careers.py          # fast

================================================================================
KEY DECISIONS & GOTCHAS
================================================================================

1. NBA HISTORICAL ABBREVIATIONS
   Static files use historical abbrs (NJN not BKN for pre-2012).
   getApiAbbreviation() in teamHistory.ts handles translation at fetch time.
   If adding a new relocated team, update BOTH teamHistory.ts AND
   HISTORICAL_ABBR dict in generate_nba_rosters.py.

2. NFL ABBREVIATIONS
   Always use current abbreviations in filenames (LAR, LV, LAC for all years).
   Alias mapping (STL→LAR etc.) is done in generate_nfl_rosters.py at write time.
   Frontend uses current abbr directly — no translation layer needed.

3. SERVER WARMUP SCREEN
   ServerWarmup.tsx still exists but is DISABLED (showWarmup=false in HomePage).
   Both sports use static files so no warmup delay. Component kept for reference.

4. CAREER MODE ON RENDER — COLD START STILL EXISTS
   Career mode first load is slow (~15-30s) due to Render free tier cold starts.
   Fix: move nba_careers.json + nfl_careers.json to public/data/ and do
   random selection client-side. Not yet implemented.

5. DIVISION MODE
   fetchDivisionRosters() in roster.ts fetches 4 teams in parallel.
   Uses static JSON files (fetchSingleTeamRoster → fetchStaticNFLRoster / fetchTeamRoster).
   Was previously slow due to sequential API calls; now instant from CDN.

6. AUTOCOMPLETE
   NBA: fetchStaticSeasonPlayers(season) → /data/players/{season}.json
   NFL: fetchStaticNFLSeasonPlayers(year) → /data/nfl/players/{year}.json
   These contain ALL players league-wide that season (not just the team roster)
   so autocomplete doesn't give away answers.

7. PPG / isLowScorer
   NBA roster files include ppg and isLowScorer (true if ppg < 10) for players
   fetched from .cache/ (which has real PPG). Players fetched via API fallback
   have ppg=0.0 and isLowScorer=false (acceptable — only affects display hints).

8. PLAYER ID TYPES
   NBA player IDs are integers. NFL player IDs are strings ("00-0033873").
   Keep this in mind when comparing or storing IDs.

9. react-window: use v1.8.x (NOT v2.x — breaking API changes in v2)

10. SUPABASE IS OPTIONAL
    App fully works without Supabase (leaderboard shows "not configured").
    Required only for multiplayer and leaderboard features.

================================================================================
RETRO THEME CSS CLASSES (src/index.css)
================================================================================

Typography:   .retro-title (Bebas Neue)   .sports-font (Oswald)
Panels:       .scoreboard-panel   .vintage-card   .player-card (.guessed)
Buttons:      .retro-btn   .retro-btn-gold   .retro-btn-blue
Inputs:       .retro-input   .retro-select
Progress:     .retro-progress   .retro-progress-fill
Utilities:    .team-badge   .pulse-glow   .scoreboard-number

CSS Variables:
  --nba-orange: #f15a29    --nba-gold: #fdb927
  --nba-red: #c8102e       --nba-blue: #17408b
  --vintage-cream: #f5f5dc --led-active: #ff6b35

================================================================================
